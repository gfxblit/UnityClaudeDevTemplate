name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

  build-webgl:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
        continue-on-error: true
        id: checkout

      - name: Pull latest changes from Claude
        run: |
          git pull origin ${{ github.event.pull_request.head.ref }} || true

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL

      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: webgl-build
          path: build/WebGL/WebGL
          retention-days: 7

  deploy-preview:
    needs: build-webgl
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr
        run: |
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true
        id: checkout

      - name: Check if gh-pages exists
        if: steps.checkout.outcome == 'failure'
        run: |
          echo "::error::gh-pages branch does not exist. Please create it first."
          echo "See workflow comments for setup instructions."
          exit 1

      - name: Download WebGL Build
        uses: actions/download-artifact@v4
        with:
          name: webgl-build
          path: pr-${{ steps.pr.outputs.number }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push preview
        run: |
          git add pr-${{ steps.pr.outputs.number }}
          git commit -m "Deploy preview for PR #${{ steps.pr.outputs.number }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const previewUrl = `https://gfxblit.github.io/UnityClaudeDevTemplate/pr-${prNumber}/`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸŽ® **WebGL Preview Deployed!**\n\n**Preview URL:** ${previewUrl}\n\nTest the build and approve the production deployment when ready.`
            });

  # deploy-production:
  #   needs: build-webgl
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #   environment:
  #     name: production
  #     url: https://gfxblit.github.io/UnityClaudeDevTemplate/
  #
  #   # IMPORTANT: Before enabling this job, create the 'production' environment:
  #   # 1. Go to Settings â†’ Environments â†’ New environment
  #   # 2. Name: production
  #   # 3. Enable "Required reviewers" and add yourself
  #   # 4. Save protection rules
  #   #
  #   # This ensures manual approval is required before production deployment.
  #
  #   steps:
  #     - name: Checkout gh-pages branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: gh-pages
  #         fetch-depth: 0
  #
  #     - name: Download WebGL Build
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: webgl-build
  #         path: .
  #
  #     - name: Configure Git
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #
  #     - name: Commit and push production
  #       run: |
  #         git add .
  #         git commit -m "Deploy production build from ${{ github.sha }}" || echo "No changes to commit"
  #         git push origin gh-pages