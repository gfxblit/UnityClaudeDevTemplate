name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-6000.0.31f1-base-3
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Activate Unity License
        run: |
          # Create activation directory
          ACTIVATE_LICENSE_PATH="$GITHUB_WORKSPACE/_activate-license"
          mkdir -p "$ACTIVATE_LICENSE_PATH"
          cd "$ACTIVATE_LICENSE_PATH"

          echo "Requesting activation (personal license)"

          # Set the license file path
          FILE_PATH=UnityLicenseFile.ulf

          # Copy license file from secret and remove carriage returns
          echo "$UNITY_LICENSE" | tr -d '\r' > $FILE_PATH

          # Activate license - this generates the .ulf in /root/.local/share/unity3d/Unity/
          ACTIVATION_OUTPUT=$(unity-editor \
              -logFile /dev/stdout \
              -quit \
              -manualLicenseFile $FILE_PATH)

          # Store the exit code
          UNITY_EXIT_CODE=$?

          # The exit code for personal activation is always 1;
          # Determine whether activation was successful by checking output
          ACTIVATION_SUCCESSFUL=$(echo "$ACTIVATION_OUTPUT" | grep 'Next license update check is after' | wc -l)

          # Set exit code to 0 if activation was successful
          if [[ $ACTIVATION_SUCCESSFUL -eq 1 ]]; then
            UNITY_EXIT_CODE=0
          fi

          # Remove input license file (cleanup)
          rm -f $FILE_PATH

          # Display result
          if [ $UNITY_EXIT_CODE -eq 0 ]; then
            echo "Activation complete."
            # Verify the license was created
            if [ -f "/root/.local/share/unity3d/Unity/Unity_lic.ulf" ]; then
              echo "License file created successfully"
              ls -lh /root/.local/share/unity3d/Unity/Unity_lic.ulf
            else
              echo "ERROR: License file was not created at expected location"
              exit 1
            fi
          else
            echo "###########################"
            echo "#         Failure         #"
            echo "###########################"
            echo ""
            echo "License activation failed."
            echo "Exit code was: $UNITY_EXIT_CODE"
            echo ""
            echo "Activation output:"
            echo "$ACTIVATION_OUTPUT"
            exit $UNITY_EXIT_CODE
          fi

          cd "$GITHUB_WORKSPACE"
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Allow Claude to use unity-editor CLI for running tests
          claude_args: '--allowed-tools Bash(unity-editor*)'

          # Optional: See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
