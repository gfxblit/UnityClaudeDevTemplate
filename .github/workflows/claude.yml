name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-6000.0.31f1-base-3
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # - name: Configure Git safe directory
      #   run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # - name: Activate Unity License
      #   run: |
      #     # Randomize machine ID for personal license (matching game-ci behavior)
      #     echo "Randomizing machine ID for personal license activation"
      #     dbus-uuidgen > /etc/machine-id && mkdir -p /var/lib/dbus/ && ln -sf /etc/machine-id /var/lib/dbus/machine-id
      #
      #     # Extract base64 data from UNITY_LICENSE XML
      #     ENCODED_DATA=$(echo "$UNITY_LICENSE" | grep -oP '(?<=<DeveloperData Value=")[^"]+' || echo "")
      #
      #     if [ -z "$ENCODED_DATA" ]; then
      #       echo "âŒ Failed to find DeveloperData in UNITY_LICENSE"
      #       exit 1
      #     fi
      #
      #     # Decode base64 and skip first 4 bytes (matching game-ci implementation)
      #     # The first 4 bytes are garbage values that need to be discarded
      #     UNITY_SERIAL=$(echo "$ENCODED_DATA" | base64 -d | tail -c +5)
      #
      #     if [ -z "$UNITY_SERIAL" ]; then
      #       echo "âŒ Failed to extract serial from DeveloperData"
      #       exit 1
      #     fi
      #
      #     echo "âœ“ Serial extracted successfully"
      #
      #     # Activate Unity with credentials
      #     # Unity will activate the license, load the project, and quit
      #     # If activation fails, Unity will exit with non-zero code
      #     echo "Activating Unity license..."
      #     unity-editor -batchmode -quit \
      #       -serial "$UNITY_SERIAL" \
      #       -username "$UNITY_EMAIL" \
      #       -password "$UNITY_PASSWORD" \
      #       -projectPath "$GITHUB_WORKSPACE" \
      #       -logFile /dev/stdout
      #
      #     echo "âœ“ Unity license activated successfully"

      # Temporarily disabled for testing WebGL build
      # - name: Run Claude Code
      #   id: claude
      #   uses: anthropics/claude-code-action@v1
      #   with:
      #     claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      #
      #     # This is an optional setting that allows Claude to read CI results on PRs
      #     additional_permissions: |
      #       actions: read
      #
      #     # Allow Claude to use unity-editor CLI for running tests
      #     claude_args: '--allowed-tools Bash(unity-editor*)'
      #
      #     # Optional: See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
      #     # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options

      - name: Skip Claude (testing WebGL build only)
        run: echo "Skipping Claude step for WebGL build testing"

  build-webgl:
    needs: claude
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Pull latest changes from Claude
        run: |
          git pull origin ${{ github.head_ref || github.ref }} || true

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: WebGL

      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: webgl-build
          path: build/WebGL
          retention-days: 7

  deploy-preview:
    # Only deploy preview for PRs, not issues
    if: github.event.pull_request.number != ''
    needs: build-webgl
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true
        id: checkout

      - name: Check if gh-pages exists
        if: steps.checkout.outcome == 'failure'
        run: |
          echo "::error::gh-pages branch does not exist. Please create it first."
          echo "See workflow comments for setup instructions."
          exit 1

      - name: Download WebGL Build
        uses: actions/download-artifact@v4
        with:
          name: webgl-build
          path: pr-${{ github.event.pull_request.number }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push preview
        run: |
          git add pr-${{ github.event.pull_request.number }}
          git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://gfxblit.github.io/UnityClaudeDevTemplate/pr-${prNumber}/`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸŽ® **WebGL Preview Deployed!**\n\n**Preview URL:** ${previewUrl}\n\nTest the build and approve the production deployment when ready.`
            });

  # deploy-production:
  #   needs: build-webgl
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #   environment:
  #     name: production
  #     url: https://gfxblit.github.io/UnityClaudeDevTemplate/
  #
  #   # IMPORTANT: Before enabling this job, create the 'production' environment:
  #   # 1. Go to Settings â†’ Environments â†’ New environment
  #   # 2. Name: production
  #   # 3. Enable "Required reviewers" and add yourself
  #   # 4. Save protection rules
  #   #
  #   # This ensures manual approval is required before production deployment.
  #
  #   steps:
  #     - name: Checkout gh-pages branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: gh-pages
  #         fetch-depth: 0
  #
  #     - name: Download WebGL Build
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: webgl-build
  #         path: .
  #
  #     - name: Configure Git
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"
  #
  #     - name: Commit and push production
  #       run: |
  #         git add .
  #         git commit -m "Deploy production build from ${{ github.sha }}" || echo "No changes to commit"
  #         git push origin gh-pages
