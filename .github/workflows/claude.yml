name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  activate-unity:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    outputs:
      unity-license: ${{ steps.export-license.outputs.license }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Activate Unity License
        uses: game-ci/unity-activate@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      - name: Export activated license
        id: export-license
        run: |
          # The license file is created in the workspace by the unity-activate action
          # Look for it in the _activate-license directory
          if [ -f "_activate-license/Unity_lic.ulf" ]; then
            LICENSE_FILE="_activate-license/Unity_lic.ulf"
          elif [ -f "$HOME/.local/share/unity3d/Unity/Unity_lic.ulf" ]; then
            LICENSE_FILE="$HOME/.local/share/unity3d/Unity/Unity_lic.ulf"
          else
            echo "Error: License file not found in expected locations"
            echo "Searching for license files..."
            find . -name "Unity_lic.ulf" -o -name "*.ulf" 2>/dev/null || true
            find $HOME -name "Unity_lic.ulf" -o -name "*.ulf" 2>/dev/null || true
            exit 1
          fi

          # Read the activated license file
          LICENSE_CONTENT=$(cat "$LICENSE_FILE")

          # Mask the license content BEFORE any output
          echo "::add-mask::$LICENSE_CONTENT"

          # Base64 encode for safe transport (not for security, already masked)
          LICENSE_B64=$(echo "$LICENSE_CONTENT" | base64 -w 0)

          # Mask the base64 version too
          echo "::add-mask::$LICENSE_B64"

          # Set as output (will be masked in logs)
          echo "license=$LICENSE_B64" >> $GITHUB_OUTPUT

  claude:
    needs: activate-unity
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-6000.0.31f1-base-3
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure Git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Unity License
        run: |
          # Create Unity license directory
          mkdir -p /root/.local/share/unity3d/Unity

          # Decode and write the license file
          echo "${{ needs.activate-unity.outputs.unity-license }}" | base64 -d > /root/.local/share/unity3d/Unity/Unity_lic.ulf

          # Verify license file was created (don't cat it!)
          ls -la /root/.local/share/unity3d/Unity/
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Allow Claude to use unity-editor CLI for running tests
          claude_args: '--allowed-tools Bash(unity-editor*)'

          # Optional: See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
